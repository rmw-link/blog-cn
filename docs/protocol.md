# 对等网通讯协议设计

在构建软件之前，先定义通讯协议。

协议的目标是实现一个对等的人民网络 ：人人平等，无中心服务器，无人垄断数据。

## 身份秘钥

加入人民网络前，首先要生成身份秘钥。

身份秘钥是Ed25519密钥对。

首次启动时，客户端会自动生成一个密钥对。

不同设备可以导入同一秘钥，也就是说，你的平板、手机、电脑可以同时在线。

如果身份秘钥丢失了，只能放弃原有的账户，重新生成一个新的身份。

所以，务必对秘钥做好备份。

## 探测在线

假设有两个节点：A 和 B （一个节点就是一个在线的人民网设备）。

A要和B建立首次连接。

首先，A发送一个字节的UDP包进行PING，包的内容为 0x01 。

B收到了内容为 0x01 的UDP包，响应一个空的UDP包标识自己在线。

这第一步，目的用来探测对方是否在线。

将探测在线的包设计的足够小、同时选用UDP作为底层通讯协议，是为了方便端口扫描、打洞、内网穿透，进而实现任意节点之间互联互通和大文件的分发。

协议设计中发送的包比响应的包尺寸更大（发送1个字节，响应0个字节），可避免恶意节点伪造网络地址从事UDP反射放大攻击。

A把正在探测中节点的IP地址和端口放入带超时的缓存。

A收到B的空包响应后，首先检查缓存，确认B的IP地址和端口是否在探测中，如果不在就忽略（同样是为了避免放大攻击）。

超时缓存的代码实现上，我们使用修改版的[retainer](https://github.com/gcxfd/retainer)，与原实现相比，添加了获取创建超时时间的接口(expiration)，方便计算通讯延时。

在[udp/mod.rs](https://github.com/rmw-link/rust/blob/master/src/udp/mod.rs#L19)中定义了探测超时时间为3秒(`connecting.monitor(2, 0.5, Duration::from_secs(3))`)。

对于地球环境，3秒的超时足够了。如果将来用于地球-火星通讯，可以修改为1369秒超时（地球和火星最远距离为1342光秒）。

## 交换公钥

代码实现中(参见[ed25519-dalek-blake3](https://github.com/rmw-dart/ed25519-dalek-blake3/blob/master/src/blake3_512.rs))，我们用效率更高的blake3-512替换标准Ed25519算法中的sha512作为哈希函数。

更快是极客永恒的追求。

## 通讯加密

### 生成私匙 ( diffie hellman )

Ed25519的公钥和秘钥可以转换为X25519的公钥和秘钥。

参见:

* [USING ED25519 SIGNING KEYS FOR ENCRYPTION](https://blog.filippo.io/using-ed25519-keys-for-encryption/)
* [ed25519-dalek-blake3](https://github.com/rmw-dart/ed25519-dalek-blake3/commit/3ea98e4403942b328b1deedf322619622e4503a7])

所以，交换Ed25519公钥之后，就可以通过X25519协议生成秘钥。


### 加密解密

为了方便起见，我们用 [xxh3](https://crates.io/crates/twox-hash) 和 [blake3](https://crates.io/crates/blake3) 自定义了一套加密算法，以方便将对每个UDP包单独加密。

加密流程 ::
  
  校验码 = xxh3::Hash64(原始内容+秘钥)
  流密码 = blake3(校验码+秘钥), 哈希输出长度=内容长度
  加密内容 = 原始内容 异或 流密码
  加密校验码 = xxh3::Hash64(加密内容+秘钥) 异或 校验码
  输出 = 加密校验码 + 加密内容

解密流程 ::
  校验码 = xxh3::Hash64(加密内容+秘钥) 异或 加密校验码
  流密码 = blake3(校验码+秘钥), 哈希输出长度=内容长度
  解密内容 = 加密内容 异或 流密码
  完整性效验 : 计算 xxh3::Hash64(解密内容+秘钥) == 校验码

## 发现彼此

## 对等网络

快慢表 Kademlia 网络

参考文献 : [一种针对P2P网络优化的Kademlia路由算法](/pdf/P2P-Kademlia.pdf)








